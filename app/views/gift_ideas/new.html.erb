<h1>Add Gift Idea for <%= @recipient.name %></h1>

<%= form_with model: [@recipient, @gift_idea] do |f| %>

  <% if @gift_idea.errors.any? %>
    <div style="color: red;">
      <h2><%= pluralize(@gift_idea.errors.count, "error") %> prohibited this gift idea from being saved:</h2>
      <ul>
        <% @gift_idea.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <p>
    <%= f.label :title %><br>
    <%= f.text_field :title %>
  </p>

  <p>
    <%= f.label :notes %><br>
    <%= f.text_area :notes %>
  </p>

  <p>
    <%= f.label :url, "URL" %><br>
    <%= f.text_field :url %>
  </p>

  <p>
    <%= f.submit "Create Gift Idea" %>
    <%= button_tag "AI Suggest", type: "button", id: "ai-suggest-btn", data: { recipient_id: @recipient.id } %>
  </p>

<% end %>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const aiBtn = document.getElementById('ai-suggest-btn');

  aiBtn.addEventListener('click', function() {
    const recipientId = this.dataset.recipientId;
    const originalText = this.textContent;

    // Disable button and show loading state
    this.disabled = true;
    this.textContent = 'Generating...';

    // Fetch AI suggestion
    fetch(`/recipients/${recipientId}/gift_ideas/suggest`)
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        console.log('Received data:', data);

        // Populate form fields using name selectors
        const titleField = document.querySelector('input[name="gift_idea[title]"]');
        const notesField = document.querySelector('textarea[name="gift_idea[notes]"]');
        const urlField = document.querySelector('input[name="gift_idea[url]"]');

        if (titleField) titleField.value = data.title;
        if (notesField) notesField.value = data.notes;
        if (urlField) urlField.value = data.url;

        // Re-enable button
        this.disabled = false;
        this.textContent = originalText;
      })
      .catch(error => {
        console.error('Error fetching AI suggestion:', error);
        alert('Failed to generate AI suggestion. Please try again.');
        this.disabled = false;
        this.textContent = originalText;
      });
  });
});
</script>

<%= link_to "Back to Recipients", recipients_path %>
